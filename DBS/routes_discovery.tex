%%% Local Variables:
%%% mode: latex
%%% TeX-master: "<none>"
%%% End:

\label{sec:routes_discovery}

Chunks can be lost.\footnote{Chunks are transmitted using a
  unrealiable communication, and therefore, among other transmission
  problems, network congestion can produce a loss of chunks.} A chunk
is considered as lost when it is time to send it to the player and the
chunk has not been received.  In this situation, for each lost chunk,
the peer sends a $[\mathtt{request}~\text{lost\_chunk\_index}]$ to a
peer of the team, selected at random among the rest of the team. When
a peer $P_x$ receives a $[\mathtt{request}~\text{lost\_chunk\_index}]$
from $P_y$, $P_x$ adds $P_y$ to $\mathtt{forward}[P_o]$, where $P_o$ is
the origin peer of the chunk stored in the position
$(\text{lost\_chunk\_index}~\mathit{mod}~2B)$ of its buffer.

% As an alternative ...
\begin{comment}
origin peer of the next chunk stored in the
buffer. This peer has to characteristics: (1) it is not necessary a
neighbor peer, and (2) there is a high probability that this chunk has
been stored in the buffer ``for a long time'', so, if it is not a
neighbor, the link between it and the peer is working fairly well.
\end{comment}

%\begin{notex}
%  In the current implementation, the destination of the
%  $[\mathtt{request} ...]$ message is the neighbor with the smaller
%  chunk debt. This, a priori, has the drawback that this peer will
%  always selected for relaying all the lost chunks because i will have
%  a smaller debt as a consequence of the requests.
%\end{notex}
  
In this situation, it can happen that some peers request redundant
routes between an origin peer and itself, and therefore, some chunks
could be received more than once. If this case, for each duplicate
chunk, a peer $P_i$ should send a
$[\mathtt{prune}~\text{duplicate\_chunk\_index}]$ message to those
neighbors that have sent to it the duplicate chunk. Neighbors
receiving such message from peer $P_i$ should remove the $P_i$ from
$\mathtt{forward}[P_o]$, where $P_o$ is the origin peer of the duplicate
chunk.


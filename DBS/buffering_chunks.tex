%%% Local Variables:
%%% mode: latex
%%% TeX-master: "<none>"
%%% End:

\label{sec:buffering_chunks}

In order to hide the jitter generated by the physical network and the
protocol itself, peers need to store the received chunks in a
\emph{buffer} during a period of time before sending them to a
player. A chunk with number $x$ is inserted in the position
$(x~\mathit{mod}~2B)$ of the buffer, where $B$(see
Tab.~\ref{tab:DBS_nomenclature}) is the maximum number of chunks that
the buffer will store. In a peer's life, $B$ is a constant, but it is
not compulsory that all peers of the same team use the same $B$ value.

The buffer is implemented as a circular queue of $2B$ chunks, which is
filled up to only $B$ chunks during the \emph{buffering time} (which
is the main part of the \emph{start-up time} that the users
experiment). Chunks with a higher number (newer chunks) are inserted
in the head of the buffer. The chunk pointed by the tail of the buffer
is sent to the player, if there is a chunk in that cell of the
buffer. This action is carried out each time a new chunk is received.

The buffering time determines how much time the peers must wait for
start playing the chunks. Considering that the chunks can be lost in
transit or delayed more than $B$ times of chunk, randomly, it is
difficult to determine, a priori, the optimal buffering time. In the
current implementation of P2PSP, peers buffer a variable number of
chunks that depends on the order in which chunks are received. If
$x_1$ is the (index of the) first received chunk (the first chunk to
be played), the buffering time finishes when the chunk $x_1+B$ is
received.\footnote{Notice that all chunks with an index smaller than
  $x_1$ will be discarded, and that during the buffering time, it can
  happens that some chunks are not received on time. Therefore, it
  does not make sense to wait for $B$ chunks before stopping the
  buffering process.}

% Hablar de la relación entre B y el tamaño del team. Tal vez, cuando
% se presente la expresión de la latencia en función del grado de
% conectividad. En el caso extremo en que todos los peers se
% conectaran con todos, B >= N^*, el número máximo de peer en el team.

\begin{comment}
An heuristic that
works is the described in the Fig.~\ref{fig:DBS_peer_buffering}. As
can be seen, $\text{chunk\_to\_play}$ points to the first received
chunk, that not necessary is the received chunk with lower
index. After that, the
buffering finishes when a chunk with index $\text{chunk\_to\_play} +
\text{BUFFER\_SIZE}/2$ has been received.\footnote{This not means that
  $\text{BUFFER\_SIZE}/2$ chunks are available in the buffer.}
\end{comment}
